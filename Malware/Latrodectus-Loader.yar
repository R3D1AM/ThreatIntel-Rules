rule Latrodectus_Malware
{
    meta:
        description = "Detects Latrodectus malware family"
        author = "R3D1AM"
        date = "2024-11-29"
        version = "1.0"
        family = "Latrodectus"
        references = [
            "https://www.proofpoint.com", 
            "https://trustwave.com", 
            "https://0x0d4y.blog", 
            "https://www.bazaar.abuse.ch"
        ]
        notes = "Detects Latrodectus malware by checking for common string decryption routines, mutex names, environment checks, and C2 communications."

    strings:
        // Decryption and XOR-based routines
        $xor_pattern = { 8B 44 24 20 48 83 C0 02 48 8B C8 E8 ?? ?? ?? ?? 48 89 44 24 28 }
        $xor_key_pattern = { 0x7e 0x6e 0x10 }  // XOR decryption sequence
        $xor_decrypt_check = "xor_decrypt" ascii wide

        // Mutex to prevent re-infection
        $mutex_name = "runnung" ascii wide

        // Command line strings associated with Latrodectus execution
        $msiexec_command = "msiexec /q /i" ascii wide

        // Known encrypted communication patterns and WebDAV references
        $encrypted_comm_pattern = { EB 31 8B 44 24 48 8B D0 48 8B 44 24 40 48 8B 08 }
        $webdav_ref = "WebDAV share" ascii wide

        // Campaign ID and other system information references
        $campaign_id = "Supted" ascii wide
        $filename = "bp.dat" ascii wide
        $fnv1a_hashing = "FNV-1a" ascii wide

        // Debugging and environment check references
        $debug_check = { 85 C0 74 2B E8 ?? ?? ?? ?? 85 C0 74 22 E8 ?? ?? ?? ?? }
        $api_resolve_hash = { 8B 44 24 20 48 83 C0 02 48 8B C8 E8 ?? ?? ?? ?? 48 89 44 24 28 }

    condition:
        // Basic checks for PE format and the presence of specific strings
        uint16(0) == 0x5a4d and
        filesize < 2MB and
        (
            // Match on decryption routines, mutex, or API-related activity
            any of ($xor_pattern, $xor_key_pattern, $xor_decrypt_check) or
            $mutex_name or
            $msiexec_command or
            $encrypted_comm_pattern or
            $webdav_ref or
            $debug_check or
            $api_resolve_hash or
            $campaign_id or
            $filename or
            $fnv1a_hashing
        )
}
